pipeline {
    agent {
         docker {
            image 'maven:3.9-eclipse-temurin-17'
            args '-v maven-cache:/root/.m2'
        }
    }
    
    parameters {
        string(
            name: 'BASE_VERSION',
            defaultValue: '1.0.0',
            description: 'Base version for the artifact (e.g., 1.0.0)'
        )
        string(
            name: 'ARTIFACTORY_MAVEN_URL',
            defaultValue: 'na.artifactory.swg-devops.com/artifactory/ip-devops-team-sandbox-maven-local',
            description: 'Artifactory Maven repository URL'
        )
        // string(
        //     name: 'DOCKER_PIPELINE_NAME',
        //     defaultValue: 'docker-build-pipeline',
        //     description: 'Name of the Docker build pipeline to trigger'
        // )
        // booleanParam(
        //     name: 'TRIGGER_DOCKER_BUILD',
        //     defaultValue: true,
        //     description: 'Automatically trigger Docker build pipeline after successful Maven build'
        // )
    }
    
    environment {
        BUILD_LABEL = sh(script: "date +%Y%m%d-%H%M%S", returnStdout: true).trim()
        FULL_VERSION = "${params.BASE_VERSION}"
        ARTIFACT_ID = 'app'
        GROUP_ID = 'com.chat'
        ARTIFACTORY_CREDS = credentials('artifactory-credentials')
        GIT_COMMIT_SHA = sh(script: "git rev-parse HEAD 2>/dev/null || echo 'unknown'", returnStdout: true).trim()
        GIT_BRANCH = sh(script: "git rev-parse --abbrev-ref HEAD 2>/dev/null || echo 'unknown'", returnStdout: true).trim()
    }
    
    stages {
        // NOTE: When using "Pipeline script from SCM", Jenkins automatically checks out code
        // This stage is only needed if running as "Pipeline script" with manual code placement
        stage('Checkout') {
            when {
                expression { 
                    // Skip if code is already present (Pipeline script mode)
                    return !fileExists('pom.xml')
                }
            }
            steps {
                echo "Code not found in workspace. Please ensure code is available."
                error("pom.xml not found. For 'Pipeline script' mode, code must be in workspace. For SCM mode, configure 'Pipeline script from SCM'.")
            }
        }
        
        stage('Setup & Version') {
            steps {
                script {
                    echo "=========================================="
                    echo "Build Information"
                    echo "=========================================="
                    echo "Base Version: ${params.BASE_VERSION}"
                    echo "Build Label: ${env.BUILD_LABEL}"
                    echo "Full Version: ${env.FULL_VERSION}"
                    echo "Artifact: ${env.GROUP_ID}:${env.ARTIFACT_ID}:${env.FULL_VERSION}"
                    echo "Git Commit: ${env.GIT_COMMIT_SHA}"
                    echo "Git Branch: ${env.GIT_BRANCH}"
                    echo "Workspace: ${env.WORKSPACE}"
                    echo "=========================================="
                    
                    // Verify required files exist
                    sh """
                        echo "Verifying project files..."
                        ls -la
                        test -f pom.xml || (echo "ERROR: pom.xml not found!" && exit 1)
                        test -f Dockerfile || (echo "ERROR: Dockerfile not found!" && exit 1)
                        test -f entrypoint.sh || (echo "ERROR: entrypoint.sh not found!" && exit 1)
                        echo "All required files present!"
                    """
                    
                    // Update POM version with timestamp
                    sh """
                        mvn versions:set -DnewVersion=${env.BUILD_LABEL} -DgenerateBackupPoms=false
                        echo "Updated POM version:"
                        cat pom.xml | grep -A 1 '<version>' | head -3
                    """
                }
            }
        }
        
        stage('Clean') {
            steps {
                echo "Cleaning previous build artifacts..."
                sh './mvnw clean'
            }
        }
        
        stage('Compile') {
            steps {
                echo "Compiling source code..."
                sh './mvnw compile'
            }
        }
        
        stage('Test') {
            steps {
                echo "Running unit tests..."
                sh './mvnw test'
            }
            post {
                always {
                    junit '**/target/surefire-reports/*.xml'
                }
            }
        }
        
        stage('Package') {
            steps {
                echo "Packaging application..."
                sh './mvnw package -DskipTests'
                
                script {
                    // Verify JAR was created
                    sh """
                        echo "Verifying JAR file..."
                        ls -lh target/${env.ARTIFACT_ID}-${env.BUILD_LABEL}.jar
                        echo "JAR file created successfully!"
                    """
                }
            }
        }
        
        stage('Create Docker Context') {
            steps {
                echo "Creating docker-context.zip..."
                script {
                    sh """
                        echo "üîç Checking zip installation..."
                        if ! command -v zip &>/dev/null; then
                            echo "Installing zip..."
                            apt-get update -y
                            apt-get install -y zip
                        fi

                        mkdir docker-context
                        # Copy required files
                        cp Dockerfile docker-context/
                        cp entrypoint.sh docker-context/
                        cp .dockerignore docker-context/ || echo "No .dockerignore file found, skipping..."
                        
                        # Create the ZIP
                        echo "Creating ZIP file..."
                        cd docker-context
                        zip -r ../docker-context-${env.BUILD_LABEL}.zip .
                        cd ..
                        
                        # Verify
                        echo "=========================================="
                        echo "Docker context ZIP created:"
                        ls -lh docker-context-${env.BUILD_LABEL}.zip
                        echo "=========================================="
                        echo "Contents of docker-context.zip:"
                        unzip -l docker-context-${env.BUILD_LABEL}.zip
                        echo "=========================================="
                        
                        # Cleanup
                        rm -rf docker-context
                    """
                }
            }
        }
        
        stage('Deploy to Artifactory') {
            steps {
                echo "Uploading artifacts to Artifactory..."
                script {
                    def artifactoryUrl = "https://${params.ARTIFACTORY_MAVEN_URL}"
                    def jarPath = "hello-world/${env.GROUP_ID.replace('.', '/')}/${env.ARTIFACT_ID}/${env.FULL_VERSION}"
                    
                    // Upload JAR
                    echo "Uploading JAR file..."
                    sh """
                        curl -f -u ${ARTIFACTORY_CREDS_USR}:${ARTIFACTORY_CREDS_PSW} \
                        -T target/${env.ARTIFACT_ID}-${env.BUILD_LABEL}.jar \
                        "${artifactoryUrl}/${jarPath}/${env.ARTIFACT_ID}-${env.BUILD_LABEL}.jar"
                    """
                    
                    // Upload docker-context.zip
                    echo "Uploading docker-context.zip..."
                    sh """
                        curl -f -u ${ARTIFACTORY_CREDS_USR}:${ARTIFACTORY_CREDS_PSW} \
                        -T docker-context-${env.BUILD_LABEL}.zip \
                        "${artifactoryUrl}/${jarPath}/docker-context-${env.BUILD_LABEL}.zip"
                    """
                    
                    echo "=========================================="
                    echo "‚úÖ Artifacts uploaded successfully!"
                    echo "=========================================="
                    echo "JAR URL:"
                    echo "${artifactoryUrl}/${jarPath}/${env.ARTIFACT_ID}-${env.BUILD_LABEL}.jar"
                    echo ""
                    echo "Docker Context ZIP URL:"
                    echo "${artifactoryUrl}/${jarPath}/docker-context-${env.BUILD_LABEL}.zip"
                    echo "=========================================="
                }
            }
        }
        
        // stage('Trigger Docker Build') {
        //     when {
        //         expression { params.TRIGGER_DOCKER_BUILD == true }
        //     }
        //     steps {
        //         echo "Triggering Docker build pipeline..."
        //         script {
        //             build job: params.DOCKER_PIPELINE_NAME,
        //                 parameters: [
        //                     string(name: 'FULL_VERSION', value: env.FULL_VERSION),
        //                     string(name: 'BUILD_LABEL', value: env.BUILD_LABEL),
        //                     string(name: 'ARTIFACT_ID', value: env.ARTIFACT_ID),
        //                     string(name: 'GROUP_ID', value: env.GROUP_ID),
        //                     string(name: 'GIT_COMMIT_SHA', value: env.GIT_COMMIT_SHA),
        //                     string(name: 'GIT_BRANCH', value: env.GIT_BRANCH)
        //                 ],
        //                 wait: false
                    
        //             echo "=========================================="
        //             echo "‚úÖ Docker build pipeline triggered!"
        //             echo "Pipeline: ${params.DOCKER_PIPELINE_NAME}"
        //             echo "Version: ${env.FULL_VERSION}"
        //             echo "=========================================="
        //         }
        //     }
        // }
    }
    
    post {
        success {
            echo """
            ========================================
            ‚úÖ BUILD SUCCESSFUL
            ========================================
            Version: ${env.FULL_VERSION}
            Build Label: ${env.BUILD_LABEL}
            JAR: ${env.ARTIFACT_ID}-${env.BUILD_LABEL}.jar
            Docker Context: docker-context-${env.BUILD_LABEL}.zip
            Git Commit: ${env.GIT_COMMIT_SHA}
            Git Branch: ${env.GIT_BRANCH}
            ========================================
            """
        }
        failure {
            echo """
            ========================================
            ‚ùå BUILD FAILED
            ========================================
            Version: ${env.FULL_VERSION}
            Check the logs above for details
            ========================================
            """
        }
        always {
            // Archive artifacts
            archiveArtifacts artifacts: "target/${env.ARTIFACT_ID}-${env.BUILD_LABEL}.jar, docker-context-${env.BUILD_LABEL}.zip",
                             allowEmptyArchive: false,
                             fingerprint: true
            
            // Clean workspace
            deleteDir()
        }
    }
}
